{{ $src := .Get "src" }}
{{ $preload := .Get "preload" | default "metadata" }}

<div id="audio-inline-{{ .Ordinal }}" class="audio-player" role="region" aria-label="Audio player" data-ordinal="{{ .Ordinal }}">
  <div class="controls" aria-label="Playback controls">
    <div class="left-controls">
      <button id="play-button-{{ .Ordinal }}" class="icon-button primary" aria-label="Play audio" title="Play/Pause (Space)" data-state="play" disabled>
        <span class="icon icon-play" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" focusable="false"><path fill="currentColor" d="M8 5v14l11-7z"/></svg>
        </span>
        <span class="icon icon-pause" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" focusable="false"><path fill="currentColor" d="M6 5h4v14H6zm8 0h4v14h-4z"/></svg>
        </span>
        <span class="btn-label">Play</span>
      </button>
    </div>
    <div class="right-controls">
      <label class="speed-label" for="speed-control-{{ .Ordinal }}">Speed</label>
      <select id="speed-control-{{ .Ordinal }}" aria-label="Playback speed" title="Playback speed">
        <option value="0.5">0.5x</option>
        <option value="0.75">0.75x</option>
        <option value="1.0" selected>1.0x</option>
        <option value="1.25">1.25x</option>
        <option value="1.5">1.5x</option>
        <option value="2.0">2.0x</option>
      </select>
    </div>
  </div>

  <div class="progress-row" aria-label="Playback progress">
    <span id="elapsed-{{ .Ordinal }}" class="time" aria-live="off">0:00</span>
    <input id="progress-{{ .Ordinal }}" class="progress" type="range" min="0" max="100" value="0" step="0.1" aria-label="Seek position" disabled />
    <span id="duration-{{ .Ordinal }}" class="time" aria-live="off">0:00</span>
    <span id="index-{{ .Ordinal }}" class="index" aria-live="off" style="visibility:hidden">—</span>
  </div>

  <div id="loading-{{ .Ordinal }}" class="loading" aria-live="polite">Loading audio…</div>
  <div id="status-{{ .Ordinal }}" class="sr-only" aria-live="polite" aria-atomic="true"></div>
</div>

<script>
(function() {
  const container = document.getElementById('audio-inline-{{ .Ordinal }}');
  const ordinal = Number((container && container.dataset && container.dataset.ordinal) || '0');
  const playButton = document.getElementById(`play-button-${ordinal}`);
  const speedControl = document.getElementById(`speed-control-${ordinal}`);
  const progress = document.getElementById(`progress-${ordinal}`);
  const elapsedLabel = document.getElementById(`elapsed-${ordinal}`);
  const durationLabel = document.getElementById(`duration-${ordinal}`);
  const statusLive = document.getElementById(`status-${ordinal}`);
  const loadingDiv = document.getElementById(`loading-${ordinal}`);

  const audioSrc = '{{ $src | relURL }}';
  const preload = '{{ $preload }}';
  const audio = new Audio(audioSrc);
  audio.preload = preload;

  let state = 'stopped';
  let hasFocus = false;
  let playbackSpeed = 1.0;

  const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
  const formatTime = (t) => {
    if (!isFinite(t) || t < 0) return '0:00';
    const m = Math.floor(t / 60);
    const s = Math.floor(t % 60);
    return `${m}:${s.toString().padStart(2, '0')}`;
  };
  const setPlayVisual = (mode) => {
    const label = playButton.querySelector('.btn-label');
    if (mode === 'pause') {
      playButton.setAttribute('data-state', 'pause');
      if (label) label.textContent = 'Pause';
      playButton.setAttribute('aria-label', 'Pause audio');
      playButton.setAttribute('aria-pressed', 'true');
    } else if (mode === 'resume') {
      playButton.setAttribute('data-state', 'play');
      if (label) label.textContent = 'Resume';
      playButton.setAttribute('aria-label', 'Resume audio');
      playButton.setAttribute('aria-pressed', 'false');
    } else {
      playButton.setAttribute('data-state', 'play');
      if (label) label.textContent = 'Play';
      playButton.setAttribute('aria-label', 'Play audio');
      playButton.setAttribute('aria-pressed', 'false');
    }
  };

  function enableControls() {
    playButton.disabled = false;
    playButton.setAttribute('aria-disabled', 'false');
    progress.disabled = false;
  }

  function computeDuration() {
    let d = NaN;
    if (isFinite(audio.duration) && audio.duration > 0) {
      d = audio.duration;
    } else if (audio.seekable && audio.seekable.length) {
      d = Number(audio.seekable.end(0)) || NaN;
    }
    durationLabel.textContent = formatTime(d);
    progress.setAttribute('aria-valuetext', `0:00 of ${formatTime(d)}`);
  }

  // Setup events
  speedControl.addEventListener('change', () => {
    playbackSpeed = parseFloat(speedControl.value);
    audio.playbackRate = playbackSpeed;
  });

  audio.addEventListener('loadedmetadata', () => {
    computeDuration();
  });
  audio.addEventListener('canplaythrough', () => {
    loadingDiv.style.display = 'none';
    enableControls();
  }, { once: true });
  audio.addEventListener('error', () => {
    loadingDiv.textContent = 'Failed to load audio';
    loadingDiv.setAttribute('aria-live', 'assertive');
  });

  audio.ontimeupdate = () => {
    if (!isFinite(audio.duration) || audio.duration <= 0) return;
    const pct = (audio.currentTime / audio.duration) * 100;
    const clamped = clamp(pct, 0, 100);
    progress.value = clamped;
    progress.style.setProperty('--pct', `${clamped}%`);
    const elapsed = formatTime(audio.currentTime);
    elapsedLabel.textContent = elapsed;
    progress.setAttribute('aria-valuetext', `${elapsed} of ${formatTime(audio.duration)}`);
  };

  progress.addEventListener('input', () => {
    if (!isFinite(audio.duration) || audio.duration <= 0) return;
    const pct = parseFloat(progress.value) / 100;
    audio.currentTime = clamp(audio.duration * pct, 0, audio.duration - 0.01);
    elapsedLabel.textContent = formatTime(audio.currentTime);
    progress.style.setProperty('--pct', `${clamp(parseFloat(progress.value), 0, 100)}%`);
  });

  function pausePlayback() {
    audio.pause();
    state = 'paused';
    setPlayVisual('resume');
    statusLive.textContent = 'Paused';
  }
  function playAudio() {
    audio.playbackRate = playbackSpeed;
    audio.play();
    state = 'playing';
    setPlayVisual('pause');
    statusLive.textContent = 'Playing';
  }
  playButton.addEventListener('click', () => {
    if (state === 'playing') pausePlayback(); else playAudio();
  });

  audio.addEventListener('ended', () => {
    state = 'stopped';
    setPlayVisual('play');
  });

  // Keyboard shortcuts within container
  container.addEventListener('focusin', () => { hasFocus = true; });
  container.addEventListener('focusout', () => { setTimeout(() => { hasFocus = container.contains(document.activeElement); }, 0); });
  container.addEventListener('mouseenter', () => { hasFocus = true; });
  container.addEventListener('mouseleave', () => { hasFocus = container.contains(document.activeElement); });
  document.addEventListener('keydown', (e) => {
    if (!hasFocus) return;
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
    if (tag === 'input' || tag === 'select' || tag === 'textarea' || tag === 'button') return;
    if (e.key === ' ') {
      e.preventDefault();
      if (state === 'playing') pausePlayback(); else playAudio();
    } else if (e.key === 'ArrowLeft') {
      // small rewind
      audio.currentTime = Math.max(0, audio.currentTime - 5);
    } else if (e.key === 'ArrowRight') {
      // small forward
      if (isFinite(audio.duration)) audio.currentTime = Math.min(audio.duration - 0.01, audio.currentTime + 5);
    }
  });

  // Init
  loadingDiv.style.display = 'block';
})();
</script>

<style>
/* Shared styling to match audio_script_table */
.audio-player { padding: 10px; }

.controls { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; }
.left-controls, .right-controls { display: flex; align-items: center; gap: 8px; }
.speed-label { font-size: 12px; opacity: 0.8; }

.icon-button { display: inline-flex; align-items: center; gap: 8px; border-radius: 8px; background-color: #f2f4f8; color: #0a2a6b; border: 1px solid #d5d9e2; padding: 8px 12px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s, transform 0.02s; font-size: 14px; }
.icon-button .icon { line-height: 0; display: inline-flex; }
.icon-button.primary { background-color: #0a37a7; border-color: #0a37a7; color: #fff; }
.icon-button:hover { background-color: #e8ebf1; }
.icon-button.primary:hover { background-color: #082d8a; }
.icon-button:active { transform: translateY(1px); }
.icon-button[disabled], .icon-button[aria-disabled="true"] { opacity: 0.6; cursor: not-allowed; }
.icon-button .btn-label { user-select: none; }
@media (max-width: 520px) { .icon-button .btn-label { display: none; } }

/* Toggle play/pause icons via data-state */
button[data-state="play"] .icon-pause { display: none; }
button[data-state="pause"] .icon-play { display: none; }

/* Progress row */
.progress-row { display: grid; grid-template-columns: auto 1fr auto auto; gap: 8px; align-items: center; margin: 6px 0 10px; }
.time { font-variant-numeric: tabular-nums; font-size: 12px; color: #444; }
.index { font-size: 12px; color: #444; justify-self: end; min-width: 64px; text-align: right; }
.progress { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; border-radius: 999px; background: linear-gradient(90deg, #0a37a7 var(--pct, 0%), #e0e6ef var(--pct, 0%)); outline: none; }
.progress:disabled { opacity: 0.6; cursor: not-allowed; }
.progress::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 14px; height: 14px; background: #0a37a7; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 1px #0a37a7; cursor: pointer; }
.progress::-moz-range-thumb { width: 14px; height: 14px; background: #0a37a7; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 1px #0a37a7; cursor: pointer; }

/* Select (speed) */
select { background-color: #0a37a7; color: white; border: none; border-radius: 6px; padding: 6px 8px; cursor: pointer; font-size: 14px; }
select:hover { background-color: #082d8a; }
select option { background-color: white; color: black; }

/* Loading */
.loading { display: none; font-style: italic; color: #666; margin: 10px 0; position: relative; }
.loading::before { content: ""; width: 14px; height: 14px; border: 2px solid #d0d6e0; border-top-color: #0a37a7; border-radius: 50%; display: inline-block; margin-right: 8px; vertical-align: -2px; animation: spin 0.9s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Screen reader only */
.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 1px, 1px); white-space: nowrap; border: 0; }

/* Dark mode adjustments */
@media (prefers-color-scheme: dark) {
  .icon-button { background-color: #1e293b; color: #dbe5ff; border-color: #293548; }
  .icon-button:hover { background-color: #243043; }
  .progress { background: linear-gradient(90deg, #6ea0ff var(--pct, 0%), #2b3a55 var(--pct, 0%)); }
  .progress::-webkit-slider-thumb, .progress::-moz-range-thumb { background: #6ea0ff; box-shadow: 0 0 0 1px #6ea0ff; }
  .time, .index { color: #c9d4f0; }
}

/* Respect theme toggle via Bootstrap's data-bs-theme="dark" */
[data-bs-theme="dark"] .icon-button { background-color: #1e293b; color: #dbe5ff; border-color: #293548; }
[data-bs-theme="dark"] .icon-button:hover { background-color: #243043; }
[data-bs-theme="dark"] .progress { background: linear-gradient(90deg, #6ea0ff var(--pct, 0%), #2b3a55 var(--pct, 0%)); }
[data-bs-theme="dark"] .progress::-webkit-slider-thumb, [data-bs-theme="dark"] .progress::-moz-range-thumb { background: #6ea0ff; box-shadow: 0 0 0 1px #6ea0ff; }
[data-bs-theme="dark"] .time, [data-bs-theme="dark"] .index { color: #c9d4f0; }
</style>
