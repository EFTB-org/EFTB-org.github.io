<div id="audio-player-{{ .Ordinal }}" class="audio-player">
  <button class="conversation-button" id="play-button-{{ .Ordinal }}">Play the conversation</button>
  <div class="transcript-container" id="transcript-{{ .Ordinal }}"></div>
</div>

<script>
  (function () {
    const ordinal = {{ .Ordinal }};
  const playerId = `audio-player-${ordinal}`;
  const playButtonId = `play-button-${ordinal}`;
  const transcriptId = `transcript-${ordinal}`;

  const scriptJson = '{{ .Get "json" }}';
  const audioPath = '{{ .Get "audiopath" }}';
  const pauseDuration = 1000; // milliseconds

  fetch(scriptJson)
    .then(response => response.json())
    .then(scriptArray => {
      const transcriptDiv = document.getElementById(transcriptId);
      scriptArray.forEach((item, index) => {
        const lineElement = document.createElement('p');
        lineElement.classList.add('transcript-line');
        if (item.type === 'dialogue') {
          // Create a <strong> element for the speaker's name
          const speakerElement = document.createElement('strong');
          speakerElement.textContent = item.speaker;
          lineElement.appendChild(speakerElement);
          // Add the colon and text as plain text nodes
          lineElement.appendChild(document.createTextNode(': '));
          lineElement.appendChild(document.createTextNode(item.text));
        } else if (item.type === 'effect') {
          const effectElement = document.createElement('i');
          effectElement.textContent = `Effect: ${item.name}`;
          lineElement.appendChild(effectElement);
        }
        lineElement.dataset.index = index;
        lineElement.addEventListener('click', () => playSingleClip(index));
        transcriptDiv.appendChild(lineElement);
      });

      let currentAudio = null;
      let currentIndex = -1;
      let state = 'stopped'; // 'stopped', 'playing', 'paused'
      let isInPauseInterval = false;
      let pausedDuringPauseInterval = false;
      let timeoutId = null;
      const playButton = document.getElementById(playButtonId);

      function playSingleClip(index) {
        if (timeoutId) clearTimeout(timeoutId);
        isInPauseInterval = false;
        pausedDuringPauseInterval = false;
        state = 'stopped';
        playButton.textContent = 'Play the conversation';
        if (currentAudio) currentAudio.pause();
        currentIndex = index;
        highlightLine(index);
        const item = scriptArray[index];
        currentAudio = new Audio(audioPath + item.audio);
        currentAudio.play();
        currentAudio.onended = () => removeHighlight();
      }

      function playSequence() {
        if (timeoutId) clearTimeout(timeoutId);
        isInPauseInterval = false;
        if (state === 'paused') {
          if (pausedDuringPauseInterval) {
            isInPauseInterval = true;
            timeoutId = setTimeout(() => {
              isInPauseInterval = false;
              currentIndex++;
              playNext();
            }, pauseDuration);
          } else if (currentAudio && currentAudio.paused) {
            currentAudio.play();
          }
          state = 'playing';
          playButton.textContent = 'Pause the conversation';
        } else {
          if (currentAudio) currentAudio.pause();
          state = 'playing';
          playButton.textContent = 'Pause the conversation';
          currentIndex = 0;
          playNext();
        }
      }

      function pausePlayback() {
        if (isInPauseInterval) {
          clearTimeout(timeoutId);
          pausedDuringPauseInterval = true;
        } else {
          pausedDuringPauseInterval = false;
        }
        if (currentAudio) currentAudio.pause();
        state = 'paused';
        playButton.textContent = 'Resume the conversation';
      }

      function playNext() {
        if (currentIndex >= scriptArray.length) {
          state = 'stopped';
          playButton.textContent = 'Play the conversation';
          removeHighlight();
          return;
        }
        highlightLine(currentIndex);
        const item = scriptArray[currentIndex];
        currentAudio = new Audio(audioPath + item.audio);
        currentAudio.play();
        currentAudio.onended = () => {
          if (state === 'playing') {
            if (currentIndex < scriptArray.length - 1) {
              isInPauseInterval = true;
              timeoutId = setTimeout(() => {
                isInPauseInterval = false;
                currentIndex++;
                playNext();
              }, pauseDuration);
            } else {
              state = 'stopped';
              playButton.textContent = 'Play the conversation';
              removeHighlight();
            }
          } else {
            removeHighlight();
          }
        };
      }

      function highlightLine(index) {
        const lines = document.querySelectorAll(`#${transcriptId} .transcript-line`);
        lines.forEach(el => el.classList.remove('playing'));
        const lineElement = lines[index];
        if (lineElement) lineElement.classList.add('playing');
        const item = scriptArray[index];
      }

      function removeHighlight() {
        const lines = document.querySelectorAll(`#${transcriptId} .transcript-line`);
        lines.forEach(el => el.classList.remove('playing'));
      }

      playButton.addEventListener('click', () => {
        if (state === 'playing') pausePlayback();
        else playSequence();
      });
    })
    .catch(error => console.error('Error loading JSON:', error));
  }) ();
</script>
<style>
  .conversation-button {
    border-radius: 6px;
    background-color: #0a37a7;
    color: rgb(255, 255, 255);
    border: none;
    cursor: pointer;
    align-items: center;
    justify-content: center;
    transition: background-color 0.3s;
    padding: 2;
  }

  .transcript-line {
    cursor: pointer;
    margin: 5px 0;
    padding: 2px;
  }

  .transcript-container {
    margin: 10px 0;
    padding: 10px;
    border: 3px dashed #e0e0e0;
    border-radius: 5px;
  }

  .transcript-line.playing {
    background-color: #e0e0e0;
    font-weight: bold;
  }
</style>
